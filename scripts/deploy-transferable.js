require('dotenv').config();
const { ethers } = require('ethers');

async function deployTransferable() {
    try {
        console.log('Deploying Transferable BNB Token...');
        
        // Use BSC Testnet
        const provider = new ethers.JsonRpcProvider('https://data-seed-prebsc-1-s1.binance.org:8545/');
        
        // Fix private key format
        let privateKey = process.env.ADMIN_PRIVATE_KEY;
        if (!privateKey.startsWith('0x')) {
            privateKey = '0x' + privateKey;
        }
        
        const wallet = new ethers.Wallet(privateKey, provider);
        console.log('Deploying from:', wallet.address);
        
        // Check balance
        const balance = await provider.getBalance(wallet.address);
        console.log('Balance:', ethers.formatEther(balance), 'BNB');
        
        if (balance === 0n) {
            console.log('❌ No BNB balance. Get testnet BNB from: https://testnet.binance.org/faucet-smart');
            return;
        }
        
        // Transferable token bytecode
        const bytecode = "0x608060405234801561001057600080fd5b50336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550610800806100606000396000f3fe6080604052600436106100a05760003560e01c806370a0823111610064578063a9059cbb116100435780639dc29fac11610028578063dd62ed3e1461020c578063a9059cbb146101cc57600080fd5b8063a9059cbb146101cc57806395d89b41146101ec57600080fd5b806370a082311461016c578063095ea7b31461018c5780639dc29fac146101ac57600080fd5b806306fdde03146100a557806318160ddd146100c557806323b872dd146100e5578063313ce5671461010557806340c10f191461012557806342966c681461014557600080fd5b366100a057005b600080fd5b3480156100b157600080fd5b506100ba61022c565b6040516100bc9190610650565b60405180910390f35b3480156100d157600080fd5b506100da610269565b6040516100bc91906106a2565b3480156100f157600080fd5b506100fa61026f565b6040516100bc91906106bb565b34801561011157600080fd5b5061011a610275565b6040516100bc91906106d6565b34801561013157600080fd5b5061013a61027a565b6040516100bc91906106bb565b34801561015157600080fd5b5061015a610280565b6040516100bc91906106bb565b34801561017857600080fd5b506100da6101873660046106f1565b610286565b34801561019857600080fd5b506100fa6101a736600461071c565b6102a1565b3480156101b857600080fd5b506100fa6101c736600461071c565b610307565b3480156101d857600080fd5b506100fa6101e736600461071c565b610369565b3480156101f857600080fd5b506100ba6102016103cb565b6040516100bc9190610650565b34801561021857600080fd5b506100da610227366004610746565b610408565b60606040518060400160405280601581526020017f5472616e7366657261626c6520424e4220546f6b656e0000000000000000000081525090565b60025481565b60001981565b601281565b60001981565b60001981565b6001602052600090815260409020545b919050565b3360009081526001602052604081205482111580156102c05750600082115b80156102d457506001600160a01b03831615155b6102dd57600080fd5b3360009081526001602052604081208054849290610302908490610795565b909155505050600190565b60005433906001600160a01b0316811461032657600080fd5b6001600160a01b038316600090815260016020526040812080548492906103549084906107a8565b9091555050600254829003600255600190565b33600090815260016020526040812054821115801561038857506000821115b801561039c57506001600160a01b03831615155b6103a557600080fd5b33600090815260016020526040812080548492906103c4908490610795565b9091555050600190565b60606040518060400160405280600481526020017f46424e4200000000000000000000000000000000000000000000000000000000815250905090565b600360209081526000928352604080842090915290825290205481565b634e487b7160e01b600052602260045260246000fd5b60028110610296576102966107bb565b6000815180845260005b8181101561046f57602081850181015186830182015201610453565b506000602082860101526020601f19601f83011685010191505092915050565b6020815260006104a26020830184610449565b9392505050565b634e487b7160e01b600052601160045260246000fd5b808201808211156104d5576104d56104a9565b92915050565b801515811461029657600080fd5b6000602082840312156104fb57600080fd5b81356104a2816104db565b60ff8116811461029657600080fd5b60006020828403121561052757600080fd5b81356104a281610506565b80356001600160a01b038116811461029657600080fd5b60006020828403121561055b57600080fd5b6104a282610532565b6000806040838503121561057757600080fd5b61058083610532565b946020939093013593505050565b6000806000606084860312156105a357600080fd5b6105ac84610532565b92506105ba60208501610532565b9150604084013590509250925092565b600080604083850312156105dd57600080fd5b6105e683610532565b91506105f460208401610532565b90509250929050565b600181811c9082168061061157607f821691505b60208210810361063157634e487b7160e01b600052602260045260246000fd5b50919050565b601f821115610675576000816000526020600020601f850160051c8101602086101561066057505b601f850160051c820191505b8181101561067f5782815560010161066c565b505050505050565b81516001600160401b038111156106a0576106a0610637565b6106b4816106ae84546105fd565b84610637565b602080601f8311600181146106e957600084156106d15750858301515b600019600386901b1c1916600185901b17855561067f565b600085815260208120601f198616915b82811015610718578886015182559484019460019091019084016106f9565b508582101561073657878501515b600019600386901b1c19169055600185901b178555505b505050505050565b6000806040838503121561075957600080fd5b61076283610532565b91506105f460208401610532565b634e487b7160e01b600052601160045260246000fd5b818103818111156104d5576104d5610770565b808201808211156104d5576104d5610770565b634e487b7160e01b600052602160045260246000fdfea2646970667358221220000000000000000000000000000000000000000000000000000000000000000064736f6c63430008110033";
        
        const abi = [
            "constructor()",
            "function mint(address to, uint256 amount) external",
            "function balanceOf(address account) external view returns (uint256)",
            "function transfer(address to, uint256 amount) external returns (bool)",
            "function transferFrom(address from, address to, uint256 amount) external returns (bool)",
            "function approve(address spender, uint256 amount) external returns (bool)",
            "function allowance(address owner, address spender) external view returns (uint256)",
            "function name() external view returns (string)",
            "function symbol() external view returns (string)",
            "function decimals() external view returns (uint8)",
            "function withdrawETH() external"
        ];
        
        const factory = new ethers.ContractFactory(abi, bytecode, wallet);
        
        console.log('Deploying transferable contract...');
        const contract = await factory.deploy();
        await contract.waitForDeployment();
        
        const address = await contract.getAddress();
        console.log('✅ Transferable Contract deployed to:', address);
        
        // Update .env file
        const fs = require('fs');
        const envPath = '.env';
        let envContent = fs.readFileSync(envPath, 'utf8');
        
        if (envContent.includes('TOKEN_CONTRACT_ADDRESS=')) {
            envContent = envContent.replace(/TOKEN_CONTRACT_ADDRESS=.*/, `TOKEN_CONTRACT_ADDRESS=${address}`);
        } else {
            envContent += `\nTOKEN_CONTRACT_ADDRESS=${address}`;
        }
        
        fs.writeFileSync(envPath, envContent);
        console.log('✅ Updated .env with transferable contract address');
        
        return address;
        
    } catch (error) {
        console.error('❌ Deployment failed:', error.message);
    }
}

deployTransferable();